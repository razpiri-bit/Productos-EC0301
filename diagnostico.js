// ============================================
// SCRIPT DE DIAGN√ìSTICO AUTOM√ÅTICO
// SkillsCert EC0301 - Verificar Configuraci√≥n
// ============================================
//
// INSTRUCCIONES:
// 1. Crea un archivo: diagnostico.js
// 2. Pega este c√≥digo
// 3. Crea un archivo .env con tus variables
// 4. Ejecuta: node diagnostico.js
//
// ============================================

require('dotenv').config();
const mysql = require('mysql2/promise');
const nodemailer = require('nodemailer');
const axios = require('axios');
const Stripe = require('stripe');

// Colores para la consola
const colors = {
  reset: '\x1b[0m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  magenta: '\x1b[35m'
};

function log(color, emoji, message) {
  console.log(`${color}${emoji} ${message}${colors.reset}`);
}

// ============================================
// FUNCIONES DE DIAGN√ìSTICO
// ============================================

async function verificarVariablesEntorno() {
  log(colors.blue, 'üîç', 'Verificando variables de entorno...\n');

  const variables = {
    'STRIPE_SECRET_KEY': process.env.STRIPE_SECRET_KEY,
    'STRIPE_WEBHOOK_SECRET': process.env.STRIPE_WEBHOOK_SECRET,
    'DB_HOST': process.env.DB_HOST,
    'DB_USER': process.env.DB_USER,
    'DB_PASSWORD': process.env.DB_PASSWORD,
    'DB_NAME': process.env.DB_NAME,
    'EMAIL_USER': process.env.EMAIL_USER,
    'EMAIL_PASSWORD': process.env.EMAIL_PASSWORD,
    'WHATSAPP_TOKEN': process.env.WHATSAPP_TOKEN,
    'WHATSAPP_PHONE_ID': process.env.WHATSAPP_PHONE_ID
  };

  let todasConfiguradas = true;

  for (const [key, value] of Object.entries(variables)) {
    if (value && value.length > 0) {
      const preview = value.substring(0, 10) + '...';
      log(colors.green, '‚úÖ', `${key}: ${preview}`);
    } else {
      log(colors.red, '‚ùå', `${key}: NO CONFIGURADA`);
      todasConfiguradas = false;
    }
  }

  console.log('');
  return todasConfiguradas;
}

async function verificarStripe() {
  log(colors.blue, 'üí≥', 'Verificando conexi√≥n con Stripe...\n');

  try {
    if (!process.env.STRIPE_SECRET_KEY) {
      log(colors.red, '‚ùå', 'STRIPE_SECRET_KEY no configurada');
      return false;
    }

    const stripe = new Stripe(process.env.STRIPE_SECRET_KEY);
    
    // Intentar listar los √∫ltimos 3 pagos
    const charges = await stripe.charges.list({ limit: 3 });
    
    log(colors.green, '‚úÖ', 'Conexi√≥n exitosa con Stripe');
    log(colors.green, 'üìä', `Encontrados ${charges.data.length} pagos recientes`);

    if (charges.data.length > 0) {
      log(colors.green, 'üí∞', `√öltimo pago: ${charges.data[0].amount / 100} ${charges.data[0].currency.toUpperCase()}`);
    }

    // Verificar webhook secret
    if (process.env.STRIPE_WEBHOOK_SECRET) {
      if (process.env.STRIPE_WEBHOOK_SECRET.startsWith('whsec_')) {
        log(colors.green, '‚úÖ', 'STRIPE_WEBHOOK_SECRET tiene formato correcto');
      } else {
        log(colors.yellow, '‚ö†Ô∏è', 'STRIPE_WEBHOOK_SECRET no tiene el formato esperado (whsec_xxx)');
      }
    } else {
      log(colors.red, '‚ùå', 'STRIPE_WEBHOOK_SECRET no configurado');
    }

    console.log('');
    return true;

  } catch (error) {
    log(colors.red, '‚ùå', `Error conectando con Stripe: ${error.message}`);
    console.log('');
    return false;
  }
}

async function verificarMySQL() {
  log(colors.blue, 'üóÑÔ∏è', 'Verificando conexi√≥n con MySQL...\n');

  try {
    if (!process.env.DB_HOST || !process.env.DB_USER || !process.env.DB_PASSWORD) {
      log(colors.red, '‚ùå', 'Faltan credenciales de MySQL');
      return false;
    }

    const connection = await mysql.createConnection({
      host: process.env.DB_HOST,
      port: process.env.DB_PORT || 3306,
      user: process.env.DB_USER,
      password: process.env.DB_PASSWORD,
      database: process.env.DB_NAME
    });

    log(colors.green, '‚úÖ', 'Conexi√≥n exitosa con MySQL');

    // Verificar si existe la tabla access_codes
    const [tables] = await connection.execute(
      "SHOW TABLES LIKE 'access_codes'"
    );

    if (tables.length > 0) {
      log(colors.green, '‚úÖ', 'Tabla access_codes existe');

      // Contar registros
      const [count] = await connection.execute(
        "SELECT COUNT(*) as total FROM access_codes"
      );
      log(colors.green, 'üìä', `C√≥digos en BD: ${count[0].total}`);

      // Mostrar estructura de la tabla
      const [columns] = await connection.execute(
        "DESCRIBE access_codes"
      );
      log(colors.green, 'üìã', `Columnas en la tabla: ${columns.length}`);

    } else {
      log(colors.red, '‚ùå', 'Tabla access_codes NO existe');
      log(colors.yellow, 'üí°', 'Debes ejecutar el script crear_tabla_mysql.sql');
    }

    await connection.end();
    console.log('');
    return true;

  } catch (error) {
    log(colors.red, '‚ùå', `Error conectando con MySQL: ${error.message}`);
    console.log('');
    return false;
  }
}

async function verificarEmail() {
  log(colors.blue, 'üìß', 'Verificando configuraci√≥n de Email (Gmail)...\n');

  try {
    if (!process.env.EMAIL_USER || !process.env.EMAIL_PASSWORD) {
      log(colors.red, '‚ùå', 'Faltan credenciales de Gmail');
      return false;
    }

    log(colors.green, '‚úÖ', `EMAIL_USER: ${process.env.EMAIL_USER}`);

    // Verificar longitud de la contrase√±a
    const passwordLength = process.env.EMAIL_PASSWORD.length;
    if (passwordLength === 16) {
      log(colors.green, '‚úÖ', 'EMAIL_PASSWORD tiene 16 caracteres (correcto para App Password)');
    } else {
      log(colors.yellow, '‚ö†Ô∏è', `EMAIL_PASSWORD tiene ${passwordLength} caracteres (deber√≠a tener 16)`);
      log(colors.yellow, 'üí°', 'Aseg√∫rate de usar una App Password de Gmail, no tu contrase√±a normal');
    }

    // Intentar crear un transporter (no env√≠a email, solo verifica credenciales)
    const transporter = nodemailer.createTransport({
      service: 'gmail',
      auth: {
        user: process.env.EMAIL_USER,
        pass: process.env.EMAIL_PASSWORD
      }
    });

    // Verificar la conexi√≥n
    await transporter.verify();
    log(colors.green, '‚úÖ', 'Conexi√≥n exitosa con Gmail');

    console.log('');
    return true;

  } catch (error) {
    log(colors.red, '‚ùå', `Error con Gmail: ${error.message}`);
    
    if (error.message.includes('Invalid login')) {
      log(colors.yellow, 'üí°', 'Verifica que est√©s usando una App Password de Gmail');
      log(colors.yellow, 'üí°', 'Gu√≠a: https://myaccount.google.com/apppasswords');
    }
    
    console.log('');
    return false;
  }
}

async function verificarWhatsApp() {
  log(colors.blue, 'üì±', 'Verificando configuraci√≥n de WhatsApp...\n');

  try {
    if (!process.env.WHATSAPP_TOKEN || !process.env.WHATSAPP_PHONE_ID) {
      log(colors.red, '‚ùå', 'Faltan credenciales de WhatsApp');
      return false;
    }

    const tokenLength = process.env.WHATSAPP_TOKEN.length;
    log(colors.green, '‚úÖ', `WHATSAPP_TOKEN: ${process.env.WHATSAPP_TOKEN.substring(0, 10)}... (${tokenLength} chars)`);
    log(colors.green, '‚úÖ', `WHATSAPP_PHONE_ID: ${process.env.WHATSAPP_PHONE_ID}`);

    // Intentar obtener informaci√≥n del n√∫mero de tel√©fono
    const response = await axios.get(
      `https://graph.facebook.com/v18.0/${process.env.WHATSAPP_PHONE_ID}`,
      {
        headers: {
          'Authorization': `Bearer ${process.env.WHATSAPP_TOKEN}`
        }
      }
    );

    log(colors.green, '‚úÖ', 'Conexi√≥n exitosa con WhatsApp Cloud API');
    log(colors.green, 'üìû', `N√∫mero verificado: ${response.data.display_phone_number}`);

    console.log('');
    return true;

  } catch (error) {
    log(colors.red, '‚ùå', `Error con WhatsApp: ${error.response?.data?.error?.message || error.message}`);
    
    if (error.response?.status === 401) {
      log(colors.yellow, 'üí°', 'El token de WhatsApp es inv√°lido o ha expirado');
      log(colors.yellow, 'üí°', 'Genera un nuevo token en: https://developers.facebook.com');
    }
    
    console.log('');
    return false;
  }
}

// ============================================
// FUNCI√ìN PRINCIPAL
// ============================================

async function diagnosticar() {
  console.log('\n');
  log(colors.magenta, 'üî¨', '='.repeat(60));
  log(colors.magenta, 'üî¨', 'DIAGN√ìSTICO AUTOM√ÅTICO - SkillsCert EC0301');
  log(colors.magenta, 'üî¨', '='.repeat(60));
  console.log('\n');

  const resultados = {
    variables: false,
    stripe: false,
    mysql: false,
    email: false,
    whatsapp: false
  };

  // 1. Variables de entorno
  resultados.variables = await verificarVariablesEntorno();

  // 2. Stripe
  if (process.env.STRIPE_SECRET_KEY) {
    resultados.stripe = await verificarStripe();
  } else {
    log(colors.red, '‚è≠Ô∏è', 'Saltando verificaci√≥n de Stripe (no configurado)\n');
  }

  // 3. MySQL
  if (process.env.DB_HOST) {
    resultados.mysql = await verificarMySQL();
  } else {
    log(colors.red, '‚è≠Ô∏è', 'Saltando verificaci√≥n de MySQL (no configurado)\n');
  }

  // 4. Email
  if (process.env.EMAIL_USER) {
    resultados.email = await verificarEmail();
  } else {
    log(colors.red, '‚è≠Ô∏è', 'Saltando verificaci√≥n de Email (no configurado)\n');
  }

  // 5. WhatsApp
  if (process.env.WHATSAPP_TOKEN) {
    resultados.whatsapp = await verificarWhatsApp();
  } else {
    log(colors.red, '‚è≠Ô∏è', 'Saltando verificaci√≥n de WhatsApp (no configurado)\n');
  }

  // Resumen
  console.log('\n');
  log(colors.magenta, 'üìä', '='.repeat(60));
  log(colors.magenta, 'üìä', 'RESUMEN DEL DIAGN√ìSTICO');
  log(colors.magenta, 'üìä', '='.repeat(60));
  console.log('\n');

  const items = [
    { nombre: 'Variables de entorno', resultado: resultados.variables },
    { nombre: 'Stripe', resultado: resultados.stripe },
    { nombre: 'MySQL', resultado: resultados.mysql },
    { nombre: 'Email (Gmail)', resultado: resultados.email },
    { nombre: 'WhatsApp Cloud API', resultado: resultados.whatsapp }
  ];

  items.forEach(item => {
    if (item.resultado) {
      log(colors.green, '‚úÖ', item.nombre);
    } else {
      log(colors.red, '‚ùå', item.nombre);
    }
  });

  const exitosos = Object.values(resultados).filter(r => r).length;
  const total = Object.keys(resultados).length;

  console.log('\n');
  log(colors.magenta, 'üéØ', `Resultado: ${exitosos}/${total} verificaciones exitosas`);

  if (exitosos === total) {
    log(colors.green, 'üéâ', '¬°TODO EST√Å CONFIGURADO CORRECTAMENTE!');
    log(colors.green, 'üöÄ', 'Tu sistema deber√≠a funcionar sin problemas');
  } else {
    log(colors.yellow, '‚ö†Ô∏è', 'Hay problemas de configuraci√≥n');
    log(colors.yellow, 'üìö', 'Consulta la documentaci√≥n para resolverlos');
  }

  console.log('\n');
  log(colors.magenta, 'üìö', 'Documentaci√≥n disponible:');
  log(colors.blue, 'üìÑ', 'DIAGNOSTICO_Y_SOLUCION.md - Gu√≠a completa');
  log(colors.blue, 'üìÑ', 'SOLUCION_RAPIDA.md - Soluci√≥n en 5 pasos');
  log(colors.blue, 'üìÑ', 'GUIA_CREDENCIALES.md - C√≥mo obtener credenciales');
  log(colors.blue, 'üìÑ', 'CHECKLIST_IMPLEMENTACION.md - Lista de verificaci√≥n');
  console.log('\n');
}

// Ejecutar diagn√≥stico
diagnosticar().catch(error => {
  log(colors.red, 'üí•', `Error inesperado: ${error.message}`);
  console.error(error);
  process.exit(1);
});
